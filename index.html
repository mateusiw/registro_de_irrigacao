<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Relatório de Irrigação</title>

    <!-- Configurações PWA -->
    <meta name="theme-color" content="#15803d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Irrigação">

    <!-- Ícone -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/S7Jzv77.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/S7Jzv77.png">

    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        input, select { user-select: text; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Grid para o PDF - 3 COLUNAS */
        #pdf-grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            align-content: start;
        }
        
        /* Estilo do Cartão no PDF */
        .pdf-card {
            background: #fff;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 8px 12px;
            box-shadow: none;
            break-inside: avoid;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* REMOVIDO .pdf-valve-row fixo para usar Tailwind e permitir múltiplas linhas (obs) */
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-24 safe-area-bottom">

    <!-- Navbar -->
    <div class="bg-green-700 text-white px-4 py-3 flex justify-between items-center shadow-lg sticky top-0 z-40 pt-safe-top">
        <div class="flex items-center gap-3">
            <!-- LOGO SEM FUNDO BRANCO -->
            <img src="https://i.imgur.com/S7Jzv77.png" alt="Logo" class="h-10 w-auto">
            <div>
                <h1 class="text-lg font-bold leading-tight tracking-tight">Registro Irrigação</h1>
                <p class="text-[10px] text-green-100 font-medium">SPG Oásis</p>
            </div>
        </div>
        
        <!-- Área da Direita: Contador e Botões -->
        <div class="flex gap-2 items-center">
            <!-- Contador com Rótulo -->
            <div class="flex flex-col items-end mr-1">
                <span class="text-[9px] text-green-200 font-bold uppercase tracking-wider">Irrigações Realizadas</span>
                <span id="recordCountBadge" class="text-sm font-mono font-bold text-white leading-none">0</span>
            </div>
            
            <!-- Botão CSV (NOVO) -->
            <button type="button" onclick="window.downloadCSV()" class="flex items-center justify-center gap-1 px-3 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg shadow-md border border-slate-500 transition-all active:scale-95" title="Baixar CSV">
                <i data-lucide="sheet" class="w-4 h-4"></i>
                <span class="text-xs font-bold hidden sm:inline-block">CSV</span>
            </button>

            <!-- Botão PDF -->
            <button type="button" id="btnDownload" onclick="window.downloadPDF()" class="flex items-center justify-center gap-2 px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg shadow-md border border-red-500 transition-all active:scale-95">
                <i data-lucide="file-down" class="w-4 h-4"></i>
                <span class="text-xs font-bold hidden sm:inline-block">PDF</span>
                <span class="text-xs font-bold sm:hidden">PDF</span>
            </button>
        </div>
    </div>

    <div class="container mx-auto p-4 space-y-6 max-w-md">
        
        <!-- 1. RESPONSÁVEL -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 flex items-center gap-3">
            <div class="bg-green-100 p-2 rounded-lg text-green-700">
                <i data-lucide="user" class="w-5 h-5"></i>
            </div>
            <div class="flex-1">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Responsável</label>
                <select id="collaborator" onchange="window.saveCollaborator()" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block p-2 outline-none">
                    <option value="ANTONIO AIRTON CORDEIRO DE BRITO">ANTONIO AIRTON CORDEIRO DE BRITO</option>
                    <option value="ALEXANDRO RIBEIRO LIMA">ALEXANDRO RIBEIRO LIMA</option>
                    <option value="FRANCISCO FÁBIO TEXEIRA PEREIRA">FRANCISCO FÁBIO TEXEIRA PEREIRA</option>
                    <option value="RAFAEL SARAIVA DE LIMA">RAFAEL SARAIVA DE LIMA</option>
                </select>
            </div>
        </div>

        <!-- 2. FORMULÁRIO DETALHADO -->
        <div id="formContainer" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 transition-colors duration-300">
            <div class="flex justify-between items-center mb-4">
                <h2 id="formTitle" class="text-lg font-semibold text-green-800 flex items-center gap-2">
                    <i data-lucide="activity" class="w-5 h-5"></i> <span id="formTitleText">Novo Registro</span>
                </h2>
                <button id="cancelEditBtn" type="button" onclick="window.cancelEdit()" class="hidden text-xs text-red-500 font-bold hover:text-red-700 underline">
                    Cancelar
                </button>
            </div>
            
            <form onsubmit="window.addRecord(event)" class="space-y-4">
                
                <!-- DATA -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Data do Registro</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                            <i data-lucide="calendar" class="w-5 h-5"></i>
                        </div>
                        <input type="date" id="date" required class="w-full bg-slate-50 border border-slate-300 rounded-lg py-2.5 pl-10 pr-3 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 text-slate-800">
                    </div>
                </div>

                <!-- SEÇÃO LOCALIZAÇÃO -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Localização</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Bloco / Setor</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                    <i data-lucide="map-pin" class="w-4 h-4"></i>
                                </div>
                                <!-- INPUT COM RESTRIÇÃO (MAX 2 CARACTERES, UPPERCASE) -->
                                <input type="text" id="block" required maxlength="2" placeholder="1 ou A" 
                                    oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')"
                                    class="w-full bg-slate-50 border border-slate-300 rounded-lg py-2 pl-9 pr-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 uppercase text-slate-800 font-medium text-center">
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Nº Válvula</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                    <i data-lucide="hash" class="w-4 h-4"></i>
                                </div>
                                <input type="number" id="valve" required placeholder="0" class="w-full bg-slate-50 border border-slate-300 rounded-lg py-2 pl-9 pr-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 text-slate-800 font-medium text-center">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SEÇÃO TEMPO (COM CÁLCULO) -->
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tempo de Execução</label>
                    <div class="grid grid-cols-2 gap-4 mb-2">
                        <div>
                            <label class="block text-[10px] text-green-700 font-bold mb-1">INÍCIO</label>
                            <input type="time" id="startTime" oninput="window.updateLiveDuration()" required class="w-full bg-white border border-slate-300 rounded-lg py-2 px-1 text-center font-mono text-sm focus:outline-none focus:ring-2 focus:ring-green-500 text-slate-800">
                        </div>
                        <div>
                            <label class="block text-[10px] text-red-700 font-bold mb-1">FIM</label>
                            <input type="time" id="endTime" oninput="window.updateLiveDuration()" required class="w-full bg-white border border-slate-300 rounded-lg py-2 px-1 text-center font-mono text-sm focus:outline-none focus:ring-2 focus:ring-red-500 text-slate-800">
                        </div>
                    </div>
                    <!-- Mostrador de Duração em Tempo Real -->
                    <div class="flex justify-between items-center pt-2 border-t border-slate-200 mt-2">
                        <span class="text-[10px] text-slate-400 uppercase tracking-wide">Duração Calculada:</span>
                        <span id="liveDuration" class="text-xs font-bold text-slate-700 font-mono">--h --min</span>
                    </div>
                </div>

                <!-- NOVO CAMPO: OBSERVAÇÕES -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Observações</label>
                    <div class="relative">
                        <div class="absolute top-2.5 left-0 pl-3 flex items-start pointer-events-none text-slate-400">
                            <i data-lucide="message-square" class="w-5 h-5"></i>
                        </div>
                        <textarea id="observation" rows="2" class="w-full bg-slate-50 border border-slate-300 rounded-lg py-2 pl-10 pr-3 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 text-slate-800 resize-none" placeholder="Opcional..."></textarea>
                    </div>
                </div>

                <!-- Botão Salvar -->
                <button type="submit" id="submitBtn" class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-bold py-3.5 rounded-xl shadow-md transition-all flex items-center justify-center gap-2 active:scale-95 touch-manipulation mt-2">
                    <i data-lucide="save" class="w-5 h-5"></i> <span id="submitBtnText">Registrar Irrigação</span>
                </button>
            </form>
        </div>

        <!-- 3. LISTA DE REGISTROS -->
        <section class="space-y-3">
            <div class="flex justify-between items-center px-1">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider">Relatório Diário de Irrigação</h3>
                <button type="button" onclick="window.clearAll()" class="text-xs text-red-400 hover:text-red-600 font-semibold underline cursor-pointer">Limpar Tudo</button>
            </div>
            
            <!-- Lista -->
            <div id="recordsList" class="space-y-4"></div>
            
            <!-- Estado Vazio -->
            <div id="emptyState" class="hidden text-center py-10 text-slate-400 bg-white rounded-xl border border-dashed border-slate-300">
                <i data-lucide="droplet" class="w-12 h-12 mx-auto mb-2 opacity-20"></i>
                <p>Nenhuma irrigação registrada.</p>
            </div>
        </section>
    </main>

    <!-- ÁREA OCULTA PARA GERAÇÃO DO PDF -->
    <div style="position: absolute; top: 0; left: -9999px;">
        <!-- Padding top zerado (pt-0) para encostar no topo -->
        <div id="pdf-report-grid" class="px-5 pb-5 pt-0 bg-white" style="font-family: Arial, sans-serif; width: 1200px;">
            
            <!-- CABEÇALHO DO PDF -->
            <div class="flex flex-col items-center justify-center mb-2 border-b-2 border-green-700 pb-2">
                <div class="flex items-center justify-between w-full mb-1 px-4 pt-2">
                    <h1 class="text-3xl font-black text-green-800 uppercase tracking-widest text-center flex-1">Relatório Diário de Irrigação</h1>
                    <img src="https://i.imgur.com/S7Jzv77.png" class="h-24 w-auto" alt="Logo">
                </div>
                
                <div class="w-full bg-slate-50 rounded-xl border border-slate-200 flex divide-x divide-slate-200 overflow-hidden shadow-sm">
                    <div class="flex-1 p-3 flex flex-col items-center justify-center">
                        <span class="block text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-1">Data de Referência</span>
                        <span id="pdfDate" class="text-base font-mono font-bold text-slate-800 leading-none"></span>
                    </div>
                    <div class="flex-[2] p-3 flex flex-col items-center justify-center bg-white">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-1">Responsável Técnico</span>
                        <span id="pdfCollaborator" class="text-xs font-bold text-slate-800 uppercase leading-none text-center"></span>
                    </div>
                    <!-- CONTADOR DE BLOCOS -->
                    <div class="flex-1 p-3 flex flex-col items-center justify-center">
                        <span class="block text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-1">Blocos Irrigados</span>
                        <span class="text-xl font-black text-green-700 leading-none">
                            <span id="pdfBlockCount">0</span>
                        </span>
                    </div>
                    
                    <!-- POSIÇÃO TROCADA: AGORA IRRIGAÇÕES VEM ANTES -->
                    <div class="flex-1 p-3 flex flex-col items-center justify-center">
                        <span class="block text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-1">Irrigações Realizadas</span>
                        <span class="text-xl font-black text-green-700 leading-none flex items-center gap-1">
                            <span id="pdfTotalCount">0</span>
                        </span>
                    </div>

                    <!-- POSIÇÃO TROCADA: AGORA HORAS VEM DEPOIS -->
                    <div class="flex-1 p-3 flex flex-col items-center justify-center">
                        <span class="block text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-1">Horas de irrigação</span>
                        <span class="text-xl font-black text-green-700 leading-none">
                            <span id="pdfTotalDuration">0h 0min</span>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Grid de Cards PDF -->
            <div id="pdf-grid-container"></div>

            <!-- Rodapé PDF -->
            <div class="mt-8 pt-4 border-t border-slate-100 text-center">
                <p class="text-[10px] text-slate-300 uppercase tracking-widest font-bold">Relatório Gerado Digitalmente • SPG OÁSIS</p>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT PURO -->
    <script>
        // Confirmação no console
        console.log("Console pronto para edição!");

        // --- 1. DEFINIÇÃO DE ESTADO ---
        let records = JSON.parse(localStorage.getItem('irrigation_records')) || [];
        let editingId = null;
        
        // NOVA VARIÁVEL DE CONTROLE
        let csvDownloaded = false;

        // --- 2. FUNÇÕES GLOBAIS ---

        window.saveCollaborator = function() {
            localStorage.setItem('irrigation_collaborator', document.getElementById('collaborator').value);
        }

        function saveData() {
            localStorage.setItem('irrigation_records', JSON.stringify(records));
            // REGRA: Se os dados mudaram, obriga a baixar o CSV novamente
            csvDownloaded = false; 
            renderList();
        }

        function calculateDuration(start, end) {
            if (!start || !end) return "--";
            const [h1, m1] = start.split(':').map(Number);
            const [h2, m2] = end.split(':').map(Number);
            let diff = (h2 * 60 + m2) - (h1 * 60 + m1);
            if (diff < 0) diff += 1440;
            const h = Math.floor(diff / 60);
            const m = diff % 60;
            return `${h}h ${m}min`;
        }

        function formatDate(isoDate) {
            if (!isoDate) return "";
            const [y, m, d] = isoDate.split('-');
            return `${d}/${m}/${y}`;
        }

        window.updateLiveDuration = function() {
            const s = document.getElementById('startTime').value;
            const e = document.getElementById('endTime').value;
            document.getElementById('liveDuration').innerText = calculateDuration(s, e);
        }

        // --- FUNÇÃO PARA EXPORTAR CSV ---
        window.downloadCSV = function() {
            if (records.length === 0) {
                alert("Não há registros para exportar.");
                return;
            }

            // Inicializa vazio (sem cabeçalho para evitar duplicidade na planilha)
            let csvContent = "";
            
            const collab = document.getElementById('collaborator').value;

            records.forEach(r => {
                const dateFmt = formatDate(r.date);
                const dur = calculateDuration(r.startTime, r.endTime);
                // Sanitiza o campo de observação removendo quebras de linha e ponto-e-vírgula
                const obs = r.observation ? r.observation.replace(/(\r\n|\n|\r)/gm, " ").replace(/;/g, ",") : "";
                
                // Monta a linha
                const row = [
                    dateFmt,
                    collab,
                    r.block,
                    r.valve,
                    r.startTime,
                    r.endTime,
                    dur,
                    obs // Nova coluna
                ].join(";");
                
                csvContent += row + "\n";
            });

            // Cria o arquivo Blob com BOM para caracteres especiais (Acentos)
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            
            const today = new Date();
            const dateStr = String(today.getDate()).padStart(2, '0') + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + today.getFullYear();
            
            // Adicionado sufixo _CSV
            link.setAttribute("download", `Dados_Irrigacao_${dateStr}_CSV.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // REGRA: Marca que o CSV foi baixado com sucesso
            csvDownloaded = true;
            
            // Feedback visual rápido
            const btn = document.querySelector('button[onclick="window.downloadCSV()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> <span class="text-xs font-bold hidden sm:inline-block">Baixado!</span>`;
            btn.classList.remove('bg-slate-600', 'hover:bg-slate-700');
            btn.classList.add('bg-green-600', 'hover:bg-green-700');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.add('bg-slate-600', 'hover:bg-slate-700');
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                if(typeof lucide !== 'undefined') lucide.createIcons();
            }, 2000);
        }

        window.resetFormState = function() {
            editingId = null;
            const formContainer = document.getElementById('formContainer');
            if(formContainer) {
                formContainer.classList.remove('ring-2', 'ring-blue-400', 'bg-blue-50');
                formContainer.classList.add('bg-white');
            }

            const submitBtn = document.getElementById('submitBtn');
            if(submitBtn) {
                submitBtn.className = "w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-bold py-3.5 rounded-xl shadow-md transition-all flex items-center justify-center gap-2 touch-manipulation mt-2";
                submitBtn.innerHTML = `<i data-lucide="save" class="w-5 h-5"></i> <span id="submitBtnText">Registrar Irrigação</span>`;
            }
            
            const title = document.getElementById('formTitleText');
            if(title) title.innerText = "Novo Registro";
            
            // Limpa observação
            document.getElementById('observation').value = '';
            
            const cancelBtn = document.getElementById('cancelEditBtn');
            if(cancelBtn) cancelBtn.classList.add('hidden');
            
            if(typeof lucide !== 'undefined') lucide.createIcons();
            renderList();
        }

        window.cancelEdit = function() {
            window.resetFormState();
            document.getElementById('block').value = '';
            document.getElementById('valve').value = '';
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
            document.getElementById('observation').value = '';
            document.getElementById('liveDuration').innerText = "--h --min";
        }

        window.addRecord = function(e) {
            e.preventDefault();
            
            const date = document.getElementById('date').value;
            const block = document.getElementById('block').value.toUpperCase();
            const valve = document.getElementById('valve').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const observation = document.getElementById('observation').value;

            if (editingId !== null) {
                const index = records.findIndex(r => r.id === editingId);
                if (index !== -1) {
                    records[index] = { ...records[index], date, block, valve, startTime, endTime, observation };
                    const btn = document.getElementById('submitBtn');
                    btn.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5"></i> Alteração Salva!`;
                    btn.className = "w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-md transition-all flex items-center justify-center gap-2 mt-2";
                    setTimeout(() => window.resetFormState(), 1000);
                }
                editingId = null;
            } else {
                const newRecord = {
                    id: Date.now(),
                    date, block, valve, startTime, endTime, observation
                };
                records.push(newRecord);
                
                // LIMPA O CAMPO OBSERVAÇÃO APÓS REGISTRAR
                document.getElementById('observation').value = '';
                
                const btn = document.getElementById('submitBtn');
                btn.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5"></i> Registro Salvo!`;
                btn.classList.add('bg-green-800', 'ring-2', 'ring-green-300');
                
                setTimeout(() => {
                    btn.innerHTML = `<i data-lucide="save" class="w-5 h-5"></i> <span id="submitBtnText">Registrar Irrigação</span>`;
                    btn.classList.remove('bg-green-800', 'ring-2', 'ring-green-300');
                    if(typeof lucide !== 'undefined') lucide.createIcons();
                }, 1500);
            }

            records.sort((a, b) => {
                if (a.block !== b.block) {
                    return a.block.localeCompare(b.block, undefined, {numeric: true});
                }
                const dateA = new Date(a.date + 'T' + a.startTime);
                const dateB = new Date(b.date + 'T' + b.startTime);
                return dateA - dateB;
            });

            saveData();
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.editRecord = function(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            document.getElementById('date').value = record.date;
            document.getElementById('block').value = record.block;
            document.getElementById('valve').value = record.valve;
            document.getElementById('startTime').value = record.startTime;
            document.getElementById('endTime').value = record.endTime;
            document.getElementById('observation').value = record.observation || '';
            
            window.updateLiveDuration();

            editingId = id;
            
            const formContainer = document.getElementById('formContainer');
            formContainer.classList.add('ring-2', 'ring-blue-400', 'bg-blue-50');
            formContainer.classList.remove('bg-white');

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-md transition-all flex items-center justify-center gap-2 mt-2";
            submitBtn.innerHTML = `<i data-lucide="save" class="w-5 h-5"></i> <span id="submitBtnText">Salvar Alterações</span>`;
            
            document.getElementById('formTitleText').innerText = "Editando Registro";
            document.getElementById('cancelEditBtn').classList.remove('hidden');

            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderList();
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.deleteRecord = function(id) {
            if(!confirm("Deseja apagar este registro?")) return;
            records = records.filter(r => r.id !== id);
            if (editingId === id) window.cancelEdit();
            saveData();
        }

        window.clearAll = function() {
            if(!confirm("Tem certeza que deseja apagar TODOS os registros?")) return;
            records = [];
            window.cancelEdit();
            saveData();
        }

        function renderList() {
            const list = document.getElementById('recordsList');
            const empty = document.getElementById('emptyState');
            const badge = document.getElementById('recordCountBadge');

            if(badge) badge.innerText = records.length;

            if (records.length === 0) {
                list.innerHTML = '';
                if(empty) empty.classList.remove('hidden');
                return;
            }

            if(empty) empty.classList.add('hidden');

            const grouped = {};
            records.forEach(rec => {
                const key = rec.block;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(rec);
            });

            const sortedKeys = Object.keys(grouped).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));

            list.innerHTML = sortedKeys.map(blockKey => {
                const blockRecords = grouped[blockKey];
                
                blockRecords.sort((a, b) => {
                     const vA = parseInt(a.valve) || 0;
                     const vB = parseInt(b.valve) || 0;
                     if(vA !== vB) return vA - vB;
                     return a.startTime.localeCompare(b.startTime);
                });

                const rowsHtml = blockRecords.map(rec => {
                    const isEditing = rec.id === editingId;
                    const bgClass = isEditing ? 'bg-blue-50' : 'hover:bg-slate-50';
                    const obsHtml = rec.observation ? `
                        <div class="mt-1 flex items-start gap-1 text-[10px] text-slate-500 italic bg-slate-50 p-1 rounded border border-slate-100">
                            <i data-lucide="message-square" class="w-3 h-3 shrink-0 mt-0.5"></i>
                            <span class="break-words">${rec.observation}</span>
                        </div>
                    ` : '';
                    
                    return `
                    <div class="flex justify-between items-start p-3 border-b border-slate-100 last:border-0 ${bgClass} transition-colors">
                        <div class="flex flex-col gap-1 w-full mr-2">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-slate-700">Válvula #${rec.valve}</span>
                                <span class="text-[10px] text-slate-400 font-mono">${rec.startTime} - ${rec.endTime}</span>
                            </div>
                            <div class="text-[10px] text-green-700 font-bold flex items-center gap-1">
                                <i data-lucide="clock" class="w-3 h-3"></i>
                                ${calculateDuration(rec.startTime, rec.endTime)}
                            </div>
                            ${obsHtml}
                        </div>
                        <div class="flex gap-1 shrink-0">
                            <button type="button" onclick="window.editRecord(${rec.id})" class="p-1.5 text-blue-400 hover:bg-blue-50 rounded" title="Editar">
                                <i data-lucide="pencil" class="w-3 h-3"></i>
                            </button>
                            <button type="button" onclick="window.deleteRecord(${rec.id})" class="p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded" title="Excluir">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                    `;
                }).join('');

                return `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                    <div class="bg-slate-50 px-4 py-2 border-b border-slate-200 flex justify-between items-center">
                        <span class="text-sm font-bold text-slate-800 uppercase">BLOCO ${blockKey}</span>
                        <span class="text-[10px] font-bold text-slate-400 bg-white px-2 py-0.5 rounded-full border border-slate-200">${blockRecords.length} Regs</span>
                    </div>
                    <div class="flex flex-col">
                        ${rowsHtml}
                    </div>
                </div>
                `;
            }).join('');
            
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.downloadPDF = async function() {
            if (records.length === 0) {
                alert("Não há registros para gerar o PDF.");
                return;
            }
            
            // REGRA DE SEGURANÇA: Verifica se o CSV já foi baixado
            if (!csvDownloaded) {
                alert("⚠️ AÇÃO NECESSÁRIA:\n\nPara garantir a segurança dos dados, é obrigatório baixar o arquivo CSV (Planilha) antes de gerar o PDF.\n\nPor favor, clique no botão 'CSV' primeiro.");
                return;
            }

            const btn = document.getElementById('btnDownload');
            const icon = btn.querySelector('i') || btn.querySelector('svg');
            
            if(icon) icon.classList.add('animate-spin');

            const pdfDateRef = records.length > 0 ? formatDate(records[0].date) : formatDate(new Date().toISOString().split('T')[0]);
            document.getElementById('pdfDate').innerText = pdfDateRef;
            document.getElementById('pdfTotalCount').innerText = records.length;
            
            // LÓGICA PARA CONTAR BLOCOS ÚNICOS
            const uniqueBlocks = new Set(records.map(r => r.block)).size;
            document.getElementById('pdfBlockCount').innerText = uniqueBlocks;

            // CÁLCULO DO TEMPO TOTAL
            let totalMinutes = 0;
            records.forEach(r => {
                if (r.startTime && r.endTime) {
                    const [h1, m1] = r.startTime.split(':').map(Number);
                    const [h2, m2] = r.endTime.split(':').map(Number);
                    let diff = (h2 * 60 + m2) - (h1 * 60 + m1);
                    if (diff < 0) diff += 1440;
                    totalMinutes += diff;
                }
            });
            const tHours = Math.floor(totalMinutes / 60);
            const tMins = totalMinutes % 60;
            document.getElementById('pdfTotalDuration').innerText = `${tHours}h ${tMins}min`;

            document.getElementById('pdfCollaborator').innerText = document.getElementById('collaborator').value;

            const gridContainer = document.getElementById('pdf-grid-container');
            
            const grouped = {};
            records.forEach(rec => {
                const k = rec.block;
                if(!grouped[k]) grouped[k] = [];
                grouped[k].push(rec);
            });

            gridContainer.innerHTML = Object.keys(grouped).map(blockKey => {
                const blockRecords = grouped[blockKey];
                
                blockRecords.sort((a, b) => {
                     const valveDiff = parseInt(a.valve) - parseInt(b.valve);
                     if(valveDiff !== 0) return valveDiff;
                     return a.startTime.localeCompare(b.startTime);
                });

                const valvesHtml = blockRecords.map((r, index) => {
                    // Verifica se é o último item para não colocar borda embaixo
                    const isLast = index === blockRecords.length - 1;
                    const borderClass = isLast ? '' : 'border-b border-dashed border-slate-200 pb-1 mb-1';
                    
                    // HTML da Observação (se existir)
                    const obsHtml = r.observation ? `
                        <div class="flex items-start gap-1 mt-0.5 ml-1">
                            <span class="text-[8px] font-bold text-slate-400 uppercase tracking-wider shrink-0">Obs:</span>
                            <span class="text-[8px] text-slate-500 italic leading-tight">${r.observation}</span>
                        </div>
                    ` : '';

                    return `
                    <div class="flex flex-col ${borderClass}">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-1 w-1/4">
                                <span class="text-[9px] text-slate-500">Val</span>
                                <span class="text-xs font-bold text-slate-700">#${r.valve}</span>
                            </div>
                            <div class="flex items-center gap-1 w-2/4 justify-center">
                                <span class="font-mono text-[10px] text-slate-600">${r.startTime}</span>
                                <span class="text-[8px] text-slate-300">➜</span>
                                <span class="font-mono text-[10px] text-slate-600">${r.endTime}</span>
                            </div>
                            <div class="w-1/4 text-right text-[10px] text-slate-500">
                                ${calculateDuration(r.startTime, r.endTime)}
                            </div>
                        </div>
                        ${obsHtml}
                    </div>
                `}).join('');

                return `
                <div class="pdf-card">
                    <div class="flex justify-between items-center border-b border-slate-200 pb-2 mb-2 bg-slate-50 -mx-3 -mt-2 px-3 pt-2">
                        <span class="text-sm font-bold text-slate-800 uppercase">BLOCO ${blockKey}</span>
                        <span class="text-[9px] text-slate-400 uppercase font-bold tracking-wider">${blockRecords.length > 1 ? blockRecords.length + ' REGISTROS' : '1 REGISTRO'}</span>
                    </div>
                    <div class="flex flex-col gap-0">
                        ${valvesHtml}
                    </div>
                </div>
            `}).join('');

            try {
                await new Promise(r => setTimeout(r, 100));

                const { jsPDF } = window.jspdf;
                const element = document.getElementById('pdf-report-grid');
                
                const canvas = await html2canvas(element, { 
                    scale: 2, 
                    useCORS: true, 
                    allowTaint: true, 
                    backgroundColor: '#ffffff'
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('l', 'mm', 'a4');
                
                const pageWidth = 297;  
                const pageHeight = 210; 
                /* Margem reduzida para 1mm para subir ao maximo */
                const margin = 1;
                const imgWidth = pageWidth - (margin * 2);
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const usablePageHeight = pageHeight - (margin * 2);

                let printedHeight = 0;
                while (printedHeight < imgHeight) {
                    if (printedHeight > 0) pdf.addPage();
                    pdf.addImage(imgData, 'PNG', margin, margin - printedHeight, imgWidth, imgHeight);
                    printedHeight += usablePageHeight;
                }

                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const year = today.getFullYear();
                
                // Adicionado sufixo _PDF
                pdf.save(`Relatorio_de_Irrigacao_${day}-${month}-${year}_SPG_OASIS_PDF.pdf`);

            } catch (err) {
                console.error(err);
                alert("Erro ao gerar PDF.");
            } finally {
                if(icon) icon.classList.remove('animate-spin');
                if(typeof lucide !== 'undefined') lucide.createIcons();
            }
        }

        // --- 3. EXPOR FUNÇÕES PARA O HTML E INICIALIZAR ---
        window.saveCollaborator = saveCollaborator;
        window.addRecord = addRecord;
        window.editRecord = editRecord;
        window.cancelEdit = cancelEdit;
        window.deleteRecord = deleteRecord;
        window.clearAll = clearAll;
        window.downloadPDF = downloadPDF;
        window.downloadCSV = downloadCSV;
        window.updateLiveDuration = updateLiveDuration;
        
        window.lucide = lucide;

        // INICIALIZAÇÃO
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('date').valueAsDate = new Date();
            const savedCollab = localStorage.getItem('irrigation_collaborator');
            if(savedCollab) {
                const collabSelect = document.getElementById('collaborator');
                if([...collabSelect.options].some(o => o.value === savedCollab)) {
                    collabSelect.value = savedCollab;
                }
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
            renderList();
        });

    </script>
</body>
</html>
